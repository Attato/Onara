import { NextPage } from 'next';
import Head from 'next/head';
import Image from 'next/image';

import fs from 'fs/promises';
import path from 'path';
import matter from 'gray-matter';
import { MDXRemote } from 'next-mdx-remote';
import { serialize } from 'next-mdx-remote/serialize';

import { useTranslation } from 'next-i18next';

import { GetServerSidePropsContext } from 'next';
import { serverSideTranslations } from 'next-i18next/serverSideTranslations';

import styles from './index.module.scss';

interface PostData {
	[key: string]: any;
}

interface Post {
	slug: string;
	frontMatter: PostData;
}

interface ChangelogPageProps {
	posts: Post[];
}

const Changelog: NextPage<ChangelogPageProps> = ({ posts }) => {
	const { t } = useTranslation();

	return (
		<>
			<Head>
				<title>Changelog</title>
				<meta name="description" content="Generated by create next app" />
				<link rel="icon" href="/icon.svg" />
				<link rel="manifest" href="/manifest.json" />
			</Head>

			<div className="min-h-screen overflow-x-hidden ">
				<div className="relative flex items-center justify-end gap-8 min-h-[400px] max-w-2xl m-auto ">
					<Image
						src="/illustrations/background_image_2.svg"
						className="w-auto h-auto max-w-none mr-[50%] translate-x-2/4 select-none"
						width={1920}
						height={400}
						alt="background"
						priority={true}
					/>
					<div className="flex flex-col items-center justify-center gap-4 w-full h-full text-center absolute text-slate-100 mx-auto">
						<h1 className="text-5xl font-black uppercase mt-10">
							Learn about the changes at Onara
						</h1>

						<p>
							Check out our Changelog to keep up to date with all the new
							features and improvements we&apos;re bringing to you. Stay up to
							date and follow the development of our product.
						</p>
					</div>
				</div>

				{posts.map((post) => {
					return (
						<div
							key={post.slug}
							className="bg-surface100 dark:bg-surface100Dark w-auto"
						>
							<div className="flex gap-4 py-20 px-6 max-w-5xl m-auto">
								<div className="sticky top-0 min-w-[232px] h-fit flex flex-col gap-1 text-colorSecondary dark:text-colorSecondaryDark text-sm">
									<p>{post.frontMatter.releaseDate}</p>
									<p>
										{post.frontMatter.isToday ? (
											<span>(Today&apos;s log)</span>
										) : (
											<span>({post.frontMatter.diffDays} days ago)</span>
										)}
									</p>
								</div>

								<div
									className={`${styles.details} text-colorPrimary dark:text-colorPrimaryDark`}
								>
									<MDXRemote
										{...post.frontMatter.content}
										components={{ Image }}
									/>
								</div>
							</div>
						</div>
					);
				})}
			</div>
		</>
	);
};

export const getFormattedDate = (fileName: string) => {
	const [day, month, year] = fileName.split('.')[0].split('-');
	const date = new Date(`${month}-${day}-${year}`);

	const options: Intl.DateTimeFormatOptions = {
		day: 'numeric',
		month: 'long',
		year: 'numeric',
	};

	const formattedDate = date.toLocaleDateString('en-US', options);
	const today = new Date();
	const isToday = today.toLocaleDateString('en-US', options) === formattedDate;

	const diffTime = Math.abs(today.getTime() - date.getTime());
	const diffDays =
		Math.ceil(
			(diffTime - today.getTimezoneOffset() * 60 * 1000) / (1000 * 60 * 60 * 24)
		) - 1;

	if (diffDays === 0) {
		if (isToday) {
			return { formattedDate, isToday: true, diffDays };
		}
	}

	return { formattedDate, isToday: false, diffDays };
};

const getPosts = async (): Promise<Post[]> => {
	const mdxFilesDirectory = path.join(process.cwd(), 'posts/changelog');
	const mdxFiles = await fs.readdir(mdxFilesDirectory);

	const posts = await Promise.all(
		mdxFiles.map(async (file) => {
			const slug = file.replace(/\.mdx?$/, '');
			const fullPath = path.join(mdxFilesDirectory, file);
			const fileContents = await fs.readFile(fullPath, 'utf8');
			const { data, content } = matter(fileContents);

			const mdxSource = await serialize(content, {
				scope: data,
			});

			const { formattedDate, isToday, diffDays } = getFormattedDate(slug);

			return {
				slug,
				frontMatter: {
					...data,
					content: mdxSource,
					releaseDate: formattedDate,
					isToday,
					diffDays,
				},
			};
		})
	);

	const sortedPosts = posts.sort((a, b) => {
		const dateA = new Date(a.frontMatter.releaseDate);
		const dateB = new Date(b.frontMatter.releaseDate);

		if (dateA > dateB) return -1;
		if (dateA < dateB) return 1;
		return 0;
	});

	return sortedPosts;
};

export const getServerSideProps = async (
	context: GetServerSidePropsContext
) => {
	const posts = await getPosts();

	return {
		props: {
			posts,
			...(await serverSideTranslations(context.locale || 'en', [
				'common',
				'homepage',
			])),
		},
	};
};

export default Changelog;
